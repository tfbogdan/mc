stages:
  - update-images
  - build

update-fedora30-image:
  stage: update-images
  image: docker:stable
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    IMAGE_NAME: $CI_REGISTRY_IMAGE/fedora/30/$CI_COMMIT_REF_NAME
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker pull $IMAGE_NAME:latest || true
    - docker build --cache-from $IMAGE_NAME:latest -t $IMAGE_NAME:$CI_COMMIT_SHA -t $IMAGE_NAME:latest images/fedora30
    - docker push $IMAGE_NAME:$CI_COMMIT_SHA
    - docker push $IMAGE_NAME:latest

build-fedora30:
  stage: build
  image: registry.gitlab.com/tfbogdan/rosewood/fedora30
  script:
    - mkdir build
    - cd build
    - cmake -DCMAKE_BUILD_TYPE=Release ..
    - cmake --build .
    - cmake --build . --target test

build-ubuntu-19.04:
  stage: build
  image: registry.gitlab.com/tfbogdan/rosewood/ubuntu-19.04
  script:
    - mkdir build
    - cd build
    - cmake -DCMAKE_BUILD_TYPE=Release ..
    - cmake --build .
    - cmake --build . --target test

build-openususe-tumbleweed:
  stage: build
  image: registry.gitlab.com/tfbogdan/rosewood/opensuse/tumbleweed
  script:
    - mkdir build
    - cd build
    - cmake -DCMAKE_BUILD_TYPE=Release ..
    - cmake --build .
    - cmake --build . --target test

build-archlinux:
  stage: build
  image: registry.gitlab.com/tfbogdan/rosewood/archlinux
  script:
    - mkdir build
    - cd build
    - cmake -DCMAKE_BUILD_TYPE=Release ..
    - cmake --build .
    - cmake --build . --target test
